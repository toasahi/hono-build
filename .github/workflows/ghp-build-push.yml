name: github packages docker image build push
on : push


env:
    IMAGE_NAME: hono-image

defaults:
    run:
        shell: bash
concurrency:
    group: ${{ github.workflow}}-${{github.ref}}
    cancel-in-progress: true

jobs:
    build-push:
        runs-on: ubuntu-latest
        permissions:
            packages: write # Github Packagesへの書き込みを許可
            contents: read # ソースコードのチェックアウトを許可
        timeout-minutes: 5
        steps:
            - uses: actions/checkout@v4
            - run: |
                docker run --rm -v "$(pwd):$(pwd)" -w "$(pwd)" rhysd/actionlint:latest
            - uses: docker/setup-buildx-action@v3
            - uses: docker/login-action@v3 
              with:
                registry: ghcr.io
                username: ${{ github.actor }}
                password: ${{ secrets.GITHUB_TOKEN }}
            - uses: docker/metadata-action@v5
              id: meta
              with:
                images: ghcr.io/${{ github.repository_owner}}/${{ env.IMAGE_NAME}}
                tags: |
                    type=raw,value=latest
                    type=raw,value=${{github.ref_name}}-${{github.sha}}
            - uses: docker/build-push-action@v5
              with:
                push: true
                context: .
                tags: ${{ steps.meta.outputs.tags}}
                labels: ${{ steps.meta.outputs.labels}}
            
